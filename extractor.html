<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panopto Direct Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-text {
            background-image: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold gradient-text mb-4">üéØ Panopto Direct Extractor</h1>
            <p class="text-slate-600 text-lg">Extract captions directly from Panopto videos in your browser</p>
        </div>

        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-2">Panopto Video URL:</label>
                <input
                    type="url"
                    id="video-url"
                    class="w-full border border-slate-300 rounded-lg px-4 py-3 text-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="https://qub.cloud.panopto.eu/Panopto/Pages/Viewer.aspx?id=..."
                />
            </div>

            <button
                id="extract-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                üöÄ Extract Captions
            </button>

            <div id="status" class="mt-4 text-sm"></div>
            <div id="results" class="mt-6"></div>
        </div>

        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
            <h3 class="text-yellow-800 font-semibold text-lg mb-2">‚ö†Ô∏è Important Notes:</h3>
            <ul class="text-yellow-700 text-sm space-y-1">
                <li>‚Ä¢ This tool works best when you're already signed in to Panopto in another tab</li>
                <li>‚Ä¢ Some videos may require authentication to access captions</li>
                <li>‚Ä¢ If extraction fails, try the bookmarklet method on the main page</li>
                <li>‚Ä¢ The tool will attempt to extract captions, slides, and metadata</li>
            </ul>
        </div>
    </div>

    <script>
        const videoUrlInput = document.getElementById('video-url');
        const extractBtn = document.getElementById('extract-btn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        extractBtn.addEventListener('click', async () => {
            const videoUrl = videoUrlInput.value.trim();
            if (!videoUrl) {
                alert('Please enter a Panopto video URL');
                return;
            }

            if (!videoUrl.includes('panopto.eu')) {
                alert('Please enter a valid Panopto URL (e.g., qub.cloud.panopto.eu)');
                return;
            }

            extractBtn.disabled = true;
            extractBtn.textContent = 'üîÑ Extracting...';
            statusDiv.textContent = 'Opening Panopto video in new window...';
            resultsDiv.innerHTML = '';

            try {
                // Open the Panopto video in a new window
                const panoptoWindow = window.open(videoUrl, 'panopto-extraction', 'width=1200,height=800,scrollbars=yes');
                
                // Wait a moment for the page to load
                setTimeout(() => {
                    statusDiv.textContent = 'Attempting to extract captions...';
                    
                    // Try to inject the extraction script
                    try {
                        const extractionScript = `
                            (function() {
                                console.log('üîç Starting Panopto extraction...');
                                
                                let captions = [];
                                let slides = [];
                                let metadata = {};
                                
                                try {
                                    // Method 1: Look for PanoptoViewer global object
                                    if (window.PanoptoViewer && window.PanoptoViewer.deliveryInfo) {
                                        const info = window.PanoptoViewer.deliveryInfo;
                                        console.log('‚úÖ Found PanoptoViewer.deliveryInfo');
                                        
                                        if (info.CaptionSegments && Array.isArray(info.CaptionSegments)) {
                                            captions = info.CaptionSegments.map(seg => ({
                                                start: seg.StartTime || 0,
                                                end: seg.EndTime || 0,
                                                text: seg.Text || ''
                                            }));
                                            console.log('‚úÖ Extracted', captions.length, 'captions from PanoptoViewer');
                                        }
                                        
                                        if (info.TableOfContents && Array.isArray(info.TableOfContents)) {
                                            slides = info.TableOfContents.map(slide => ({
                                                time: slide.Time || 0,
                                                title: slide.Title || '',
                                                imageUrl: slide.ImageUrl || ''
                                            }));
                                            console.log('‚úÖ Extracted', slides.length, 'slides from PanoptoViewer');
                                        }
                                        
                                        metadata = {
                                            title: info.Title || 'Panopto Video',
                                            description: info.Description || '',
                                            duration: info.Duration || 0,
                                            creator: info.Creator || '',
                                            created: info.CreatedDate || '',
                                            sessionId: info.SessionID || ''
                                        };
                                    }
                                    
                                    // Method 2: Look for Panopto global object
                                    else if (window.Panopto && window.Panopto.data && window.Panopto.data.session) {
                                        const session = window.Panopto.data.session;
                                        console.log('‚úÖ Found Panopto.data.session');
                                        metadata = {
                                            title: session.Name || 'Panopto Video',
                                            description: session.Description || '',
                                            duration: session.Duration || 0,
                                            creator: session.Creator || '',
                                            created: session.CreatedDate || '',
                                            sessionId: session.Id || ''
                                        };
                                    }

                                    // Method 3: DOM scraping for captions
                                    if (captions.length === 0) {
                                        console.log('üéØ DOM scraping for captions...');
                                        const captionSelectors = [
                                            '.caption-line',
                                            '.caption-text',
                                            '[class*="caption"]',
                                            '.transcript-line',
                                            '.subtitle-line',
                                            '.caption',
                                            '.transcript'
                                        ];
                                        
                                        for (const selector of captionSelectors) {
                                            const elements = document.querySelectorAll(selector);
                                            if (elements.length > 0) {
                                                console.log('‚úÖ Found', elements.length, 'caption elements with selector:', selector);
                                                elements.forEach((el, index) => {
                                                    const text = el.textContent?.trim();
                                                    if (text && text.length > 3) {
                                                        captions.push({
                                                            start: index * 5,
                                                            end: (index + 1) * 5,
                                                            text: text
                                                        });
                                                    }
                                                });
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // Method 4: Look for any text that might be captions
                                    if (captions.length === 0) {
                                        console.log('üéØ Looking for any caption-like text...');
                                        const allText = document.body.textContent;
                                        const lines = allText.split('\\n').filter(line => 
                                            line.trim().length > 10 && 
                                            line.trim().length < 200 &&
                                            !line.includes('Panopto') &&
                                            !line.includes('Sign in') &&
                                            !line.includes('Help') &&
                                            !line.includes('Settings') &&
                                            !line.includes('Microsoft') &&
                                            !line.includes('QUB')
                                        );
                                        
                                        if (lines.length > 0) {
                                            console.log('‚úÖ Found', lines.length, 'potential caption lines');
                                            lines.forEach((line, index) => {
                                                captions.push({
                                                    start: index * 5,
                                                    end: (index + 1) * 5,
                                                    text: line.trim()
                                                });
                                            });
                                        }
                                    }
                                    
                                    const transcript = captions.map(c => c.text).join(' ');
                                    
                                    console.log('üìä Final extraction results:', {
                                        captions: captions.length,
                                        slides: slides.length,
                                        metadata: Object.keys(metadata).length
                                    });
                                    
                                    const result = {
                                        success: true,
                                        captions: captions,
                                        slides: slides,
                                        metadata: metadata,
                                        transcript: transcript,
                                        extractionMethod: 'Direct Browser Extraction'
                                    };
                                    
                                    console.log('üéØ Final extraction result:', result);
                                    
                                    // Send result back to parent window
                                    if (window.opener) {
                                        window.opener.postMessage({
                                            type: 'PANOPTO_EXTRACTION_RESULT',
                                            data: result
                                        }, '*');
                                    }
                                    
                                    return result;
                                    
                                } catch (error) {
                                    console.error('‚ùå Extraction error:', error);
                                    if (window.opener) {
                                        window.opener.postMessage({
                                            type: 'PANOPTO_EXTRACTION_ERROR',
                                            data: { error: error.message }
                                        }, '*');
                                    }
                                    return { success: false, error: error.message, captions: [], slides: [], metadata: {} };
                                }
                            })();
                        `;

                        // Try to execute the script in the new window
                        panoptoWindow.eval(extractionScript);
                        
                        statusDiv.textContent = 'Extraction script executed. Check the new window for results.';
                        
                    } catch (error) {
                        console.error('Failed to inject extraction script:', error);
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Failed to inject extraction script. This may be due to browser security restrictions. Please try the bookmarklet method instead.</span>';
                    }
                }, 3000);

            } catch (error) {
                console.error('Extraction failed:', error);
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Failed to open Panopto video. Please check the URL and try again.</span>';
            } finally {
                extractBtn.disabled = false;
                extractBtn.textContent = 'üöÄ Extract Captions';
            }
        });

        // Listen for messages from the extraction window
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'PANOPTO_EXTRACTION_RESULT') {
                const result = event.data.data;
                displayResults(result);
            } else if (event.data && event.data.type === 'PANOPTO_EXTRACTION_ERROR') {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Extraction failed: ' + event.data.data.error + '</span>';
            }
        });

        function displayResults(result) {
            if (result.success) {
                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Extraction successful!</span>';
                resultsDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h3 class="text-green-800 font-semibold text-lg mb-4">‚úÖ Extraction Results</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-green-800">Video: ${result.metadata.title || 'Panopto Video'}</h4>
                                <p class="text-green-700">Captions: ${result.captions.length} segments</p>
                                <p class="text-green-700">Slides: ${result.slides.length} items</p>
                                <p class="text-green-700">Method: ${result.extractionMethod}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-green-800 mb-2">Transcript Preview:</h4>
                                <div class="bg-white border border-green-200 rounded-lg p-4 max-h-40 overflow-y-auto text-sm">
                                    ${result.transcript.substring(0, 500)}${result.transcript.length > 500 ? '...' : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="copyTranscript('${result.transcript.replace(/'/g, "\\'")}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    üìã Copy Transcript
                                </button>
                                <button onclick="downloadTranscript('${result.transcript.replace(/'/g, "\\'")}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    üíæ Download as TXT
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Extraction failed: ' + result.error + '</span>';
            }
        }

        function copyTranscript(transcript) {
            navigator.clipboard.writeText(transcript).then(() => {
                alert('Transcript copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy transcript:', err);
                alert('Failed to copy transcript. Please select and copy manually.');
            });
        }

        function downloadTranscript(transcript) {
            const blob = new Blob([transcript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'panopto-transcript.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
